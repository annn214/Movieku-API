<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Film - Movieku</title>
  <link rel="stylesheet" href="styles.css" />
  <meta name="movieku-api-base" content="" />
</head>
<body>
  <header>
    <h1>Edit <span>Film</span></h1>
    <nav class="top-nav">
      <a href="/">Beranda</a>
      <a href="/search">Cari</a>
      <a href="/create">Tambah</a>
      <a class="active" href="/edit">Edit</a>
      <a href="/delete">Hapus</a>
    </nav>
  </header>

  <main>
    <section class="section">
      <h2>Muat Film</h2>
      <p class="lead">Masukkan ID film untuk memuat data sebelum diubah.</p>
      <form id="load-form">
        <label>ID Film</label>
        <input type="text" name="id" required />
        <button type="submit" class="secondary">Muat</button>
      </form>
      <p id="load-status" class="status">Belum ada data dimuat.</p>
    </section>

    <section class="section">
      <h2>Form Edit</h2>
      <form id="edit-form">
        <input type="hidden" name="id" />
        <label>Judul</label>
        <input type="text" name="title" required />
        <label>Tahun</label>
        <input type="number" name="year" />
        <label>Genre</label>
        <input type="text" name="genre" />
        <label>Synopsis</label>
        <textarea name="synopsis" rows="3"></textarea>
        <label>Rating (0-10)</label>
        <input type="number" step="0.1" min="0" max="10" name="rating" />
        <button type="submit">Simpan Perubahan</button>
      </form>
      <p id="edit-status" class="status">Menunggu data dimuat...</p>
      <div id="edit-preview"></div>
    </section>

    <section class="section">
      <h2>Koneksi Backend</h2>
      <p id="backend-status" class="status">Memeriksa koneksi...</p>
      <p class="helper">Memuat dan menyimpan perubahan memerlukan token login yang valid.</p>
    </section>
  </main>

  <script type="module">
    import { fetchJSON, authHeaders, ensureAuth, renderMovieDetail, statusInfo, statusError, statusSuccess, checkBackend } from './common.js';

    const loadForm = document.getElementById('load-form');
    const editForm = document.getElementById('edit-form');
    const loadStatus = document.getElementById('load-status');
    const editStatus = document.getElementById('edit-status');
    const preview = document.getElementById('edit-preview');

    function fillForm(movie) {
      editForm.elements['id'].value = movie._id || movie.id;
      editForm.elements['title'].value = movie.title || '';
      editForm.elements['year'].value = movie.year || '';
      editForm.elements['genre'].value = Array.isArray(movie.genre) ? movie.genre.join(', ') : movie.genre || '';
      editForm.elements['synopsis'].value = movie.synopsis || '';
      editForm.elements['rating'].value = movie.rating ?? '';
    }

    loadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!ensureAuth(loadStatus)) return;
      const id = new FormData(loadForm).get('id');
      statusInfo(loadStatus, 'Memuat data film...');
      try {
        const data = await fetchJSON(`/movies/${id}`, { headers: authHeaders() });
        fillForm(data);
        renderMovieDetail(preview, data);
        statusSuccess(loadStatus, 'Data ditemukan, silakan edit.');
      } catch (err) {
        statusError(loadStatus, err.message);
      }
    });

    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!ensureAuth(editStatus)) return;
      const formData = Object.fromEntries(new FormData(editForm).entries());
      const id = formData.id;
      const payload = {
        ...formData,
        genre: formData.genre ? formData.genre.split(',').map((g) => g.trim()).filter(Boolean) : [],
      };
      if (payload.year) payload.year = Number(payload.year);
      if (payload.rating) payload.rating = Number(payload.rating);
      delete payload.id;
      statusInfo(editStatus, 'Menyimpan perubahan...');
      try {
        const data = await fetchJSON(`/movies/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(payload),
        });
        renderMovieDetail(preview, data);
        statusSuccess(editStatus, 'Perubahan tersimpan.');
      } catch (err) {
        statusError(editStatus, err.message);
      }
    });

    renderMovieDetail(preview, null);
    checkBackend(document.getElementById('backend-status'));
  </script>
</body>
</html>